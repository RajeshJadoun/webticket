<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Help Desk Tickets</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 30px 20px;
      min-height: 100vh;
    }

    .container {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 20px;
      max-width: 1100px;
      margin: auto;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h2 {
      font-size: 2em;
      color: #2c3e50;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .subtitle {
      color: #7f8c8d;
      margin-bottom: 30px;
      font-size: 0.95em;
    }

    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 18px;
      margin-bottom: 40px;
      padding: 30px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 15px;
      border: 2px solid #e0e0e0;
    }

    .full {
      grid-column: 1 / -1;
    }

    .input-group {
      position: relative;
    }

    .input-group label {
      display: block;
      margin-bottom: 6px;
      color: #495057;
      font-weight: 600;
      font-size: 0.9em;
    }

    input, textarea {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      border: 2px solid #dee2e6;
      font-size: 0.95em;
      transition: all 0.3s ease;
      background: white;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-2px);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    input[type="file"] {
      padding: 10px;
      cursor: pointer;
      border-style: dashed;
    }

    input[type="file"]:hover {
      background: #f8f9fa;
      border-color: #667eea;
    }

    button {
      background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
      color: white;
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.05em;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    h3 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 1.5em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ticket-stats {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .stat-card .number {
      font-size: 2em;
      font-weight: bold;
    }

    .stat-card .label {
      font-size: 0.9em;
      opacity: 0.9;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 14px 12px;
      border-bottom: 1px solid #f0f0f0;
      color: #495057;
      font-size: 0.95em;
    }

    tr:hover {
      background: #f8f9fa;
      transition: background 0.2s ease;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .resolve-btn {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
    }

    .resolve-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
    }

    .ticket-id {
      background: #e8f4f8;
      color: #2980b9;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 600;
      display: inline-block;
    }

    .file-link {
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    .file-link:hover {
      color: #764ba2;
      text-decoration: underline;
    }

    .no-tickets {
      text-align: center;
      padding: 60px 20px;
      color: #7f8c8d;
      font-size: 1.1em;
    }

    .no-tickets-icon {
      font-size: 4em;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
      font-size: 1.1em;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      display: inline-block;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @media (max-width: 768px) {
      .container {
        padding: 25px;
      }

      form {
        padding: 20px;
        grid-template-columns: 1fr;
      }

      h2 {
        font-size: 1.5em;
      }

      table {
        font-size: 0.85em;
      }

      th, td {
        padding: 10px 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üé´ Help Desk Ticket System</h2>
    <p class="subtitle">Manage and track support tickets efficiently</p>
    
    <form id="ticketForm">
      <div class="input-group">
        <label for="raisedBy">Raised By</label>
        <input type="text" id="raisedBy" name="raisedBy" placeholder="Your name" required>
      </div>
      <div class="input-group">
        <label for="raisedFor">Raised For</label>
        <input type="text" id="raisedFor" name="raisedFor" placeholder="Department/Person" required>
      </div>
      <div class="input-group">
        <label for="assignedTo">Assigned To</label>
        <input type="text" id="assignedTo" name="assignedTo" placeholder="Support staff" required>
      </div>
      <div class="input-group">
        <label for="fileAttachment">Attachment (optional)</label>
        <input type="file" id="fileAttachment" name="fileAttachment" />
      </div>
      <div class="input-group full">
        <label for="issue">Issue Description</label>
        <textarea id="issue" name="issue" placeholder="Describe the issue in detail..." required></textarea>
      </div>
      <button class="full" type="submit">üöÄ Raise Ticket</button>
    </form>

    <h3>üìã Active Tickets</h3>
    <div class="ticket-stats" id="ticketStats"></div>
    <div id="ticketList" class="loading"><span class="spinner">‚è≥</span>Loading tickets...</div>
  </div>

  <script>
const API_BASE_URL = "https://prenatally-nonevangelic-afton.ngrok-free.dev/api/tickets/";

// Load Tickets
async function loadTickets() {
  try {
    const res = await fetch(`${API_BASE_URL}/tickets/`);
    const data = await res.json();
    renderTickets(data);
  } catch (error) {
    document.getElementById("ticketList").innerHTML = '<div class="loading">‚ö†Ô∏è Unable to connect to server</div>';
  }
}

function renderTickets(tickets) {
  const statsHtml = `
    <div class="stat-card">
      <div class="number">${tickets.length}</div>
      <div class="label">Active Tickets</div>
    </div>
  `;
  document.getElementById("ticketStats").innerHTML = statsHtml;

  if (tickets.length === 0) {
    document.getElementById("ticketList").innerHTML = `
      <div class="no-tickets">
        <div class="no-tickets-icon">üéâ</div>
        <div>No active tickets</div>
        <div style="font-size: 0.9em; margin-top: 10px; opacity: 0.7;">All caught up!</div>
      </div>
    `;
    return;
  }

  let html = `
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Raised By</th>
            <th>For</th>
            <th>Assigned</th>
            <th>Issue</th>
            <th>Attachment</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
  `;
  tickets.forEach(t => {
    html += `
      <tr>
        <td><span class="ticket-id">#${t.id}</span></td>
        <td>${t.raisedBy}</td>
        <td>${t.raisedFor}</td>
        <td>${t.assignedTo}</td>
        <td>${t.issue}</td>
        <td>
          ${t.file ? `<a href="http://127.0.0.1:8000${t.file}" target="_blank" class="file-link">üìé Open</a>` : '<span style="color: #adb5bd;">No file</span>'}
        </td>
        <td><button class="resolve-btn" onclick="resolveTicket(${t.id})">‚úì Resolve</button></td>
      </tr>
    `;
  });
  html += "</tbody></table></div>";
  document.getElementById("ticketList").innerHTML = html;
}

// Submit Ticket
document.getElementById("ticketForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const submitBtn = e.target.querySelector('button[type="submit"]');
  submitBtn.textContent = '‚è≥ Submitting...';
  submitBtn.disabled = true;

  try {
    const res = await fetch(`${API_BASE_URL}/tickets/`, {
      method: "POST",
      body: formData
    });

    if (res.ok) {
      e.target.reset();
      loadTickets();
      submitBtn.textContent = '‚úÖ Ticket Raised!';
      setTimeout(() => {
        submitBtn.textContent = 'üöÄ Raise Ticket';
        submitBtn.disabled = false;
      }, 2000);
    }
  } catch (error) {
    submitBtn.textContent = '‚ùå Error - Try Again';
    submitBtn.disabled = false;
  }
});

// Resolve Ticket
async function resolveTicket(id) {
  if (!confirm('Are you sure you want to resolve this ticket?')) return;

  try {
    await fetch(`${API_BASE_URL}/tickets/${id}/resolve/`, {
      method: "POST"
    });
    loadTickets();
  } catch (error) {
    alert('Failed to resolve ticket. Please try again.');
  }
}

loadTickets();
setInterval(loadTickets, 5000);

  </script>
</body>
</html>
