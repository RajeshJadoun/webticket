<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Help Desk Tickets | Support Management</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #818cf8;
      --success: #10b981;
      --success-dark: #059669;
      --danger: #ef4444;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-tertiary: #f1f5f9;
      --border: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--gradient-1);
      min-height: 100vh;
      padding: 2rem 1rem;
      line-height: 1.6;
      color: var(--text-primary);
      position: relative;
      overflow-x: hidden;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--bg-primary);
      border-radius: 20px;
      box-shadow: var(--shadow-xl);
      overflow: hidden;
      position: relative;
      z-index: 1;
      backdrop-filter: blur(10px);
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 2.5rem 2rem;
      color: white;
      position: relative;
      overflow: hidden;
    }
    .header-content {
      position: relative;
      z-index: 1;
    }
    h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .subtitle { font-size: 1rem; opacity: 0.9; font-weight: 400; }
    .content-wrapper { padding: 2rem; }
    .form-section {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2.5rem;
      border: 1px solid var(--border);
    }
    .btn { padding: 0.875rem 2rem; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
    .btn-primary { background: var(--primary); color: white; box-shadow: var(--shadow-md); }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .btn-success { background: var(--success); color: white; padding: 0.5rem 1rem; font-size: 0.875rem; position: relative; }
    .btn-success:hover:not(:disabled) { background: var(--success-dark); transform: translateY(-1px); }
    .btn-success:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .table-wrapper { background: var(--bg-primary); border-radius: 12px; overflow: hidden; border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); font-size: 0.9375rem; color: var(--text-primary); }
    thead { background: var(--bg-tertiary); }
    .ticket-id { font-weight: 600; color: var(--primary); font-family: 'Courier New', monospace; }
    .file-link { color: var(--primary); text-decoration: none; font-weight: 500; }
    .no-file { color: var(--text-muted); font-style: italic; }
    .toast { position: fixed; top: 2rem; right: 2rem; background: white; color: var(--text-primary); padding: 1rem 1.5rem; border-radius: 12px; box-shadow: var(--shadow-lg); z-index: 1000; display: flex; align-items: center; gap: 0.75rem; font-weight: 500; border-left: 4px solid var(--success); }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-content">
        <h1>ðŸŽ« Help Desk Ticket System</h1>
        <p class="subtitle">Efficiently manage and track support tickets across departments</p>
      </div>
    </div>

    <div class="content-wrapper">
      <div class="form-section">
        <h2>Create New Ticket</h2>
        <form id="ticketForm">
          <input type="text" id="username" placeholder="Your Name" required>
          <input type="text" id="raisedFor" placeholder="Person's Name" required>
          <select id="department" required>
            <option value="" disabled selected>Select Department</option>
            <option value="MIS Department">MIS Department</option>
            <option value="Executive Assistant Department">Executive Assistant Department</option>
          </select>
          <textarea id="issue" placeholder="Describe issue" required></textarea>
          <input type="file" id="fileUpload">
          <button type="submit" class="btn btn-primary" id="submitBtn">ðŸš€ Raise Ticket</button>
        </form>
      </div>

      <h2>ðŸ“‹ Current Tickets</h2>
      <div class="table-wrapper">
        <div id="ticketList">
          <div class="loading">Loading tickets...</div>
        </div>
      </div>
    </div>
  </div>

<script>
  const webAppURL = "https://script.google.com/macros/s/AKfycbz_OuSoTAPH89LUeQOgYK3zgFaFjNWX8pxUmdbpnvsk6bebQusyIeuUiCZGh7oIJGPo/exec";

  function showToast(message) {
    const existingToast = document.querySelector('.toast');
    if (existingToast) existingToast.remove();
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.innerHTML = `<div>âœ“</div><div>${message}</div>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  function formatTime(timestamp) {
    if (!timestamp) return 'N/A';
    return new Date(timestamp).toLocaleString('en-IN', {
      day: '2-digit', month: 'short', year: 'numeric',
      hour: '2-digit', minute: '2-digit', hour12: true
    });
  }

  function loadTickets() {
    fetch(webAppURL)
      .then(res => res.json())
      .then(data => renderTickets(data))
      .catch(() => {
        document.getElementById("ticketList").innerHTML = "Failed to load tickets.";
      });
  }

  function renderTickets(tickets) {
    const container = document.getElementById("ticketList");
    if (!tickets || tickets.length === 0) {
      container.innerHTML = `<div>No active tickets</div>`;
      return;
    }

    let tableHTML = `<table><thead><tr>
      <th>Ticket ID</th><th>Raised For</th><th>Raised By</th><th>Department</th>
      <th>Issue</th><th>Attachment</th><th>Raised At</th><th>Action</th>
    </tr></thead><tbody>`;

    tickets.forEach(ticket => {
      const fileHTML = ticket.fileUrl 
        ? `<a href="${ticket.fileUrl}" target="_blank" class="file-link">ðŸ“Ž View File</a>`
        : '<span class="no-file">No attachment</span>';
      tableHTML += `<tr>
        <td><span class="ticket-id">#${ticket.id}</span></td>
        <td>${ticket.raisedFor}</td>
        <td>${ticket.name}</td>
        <td>${ticket.department}</td>
        <td>${ticket.issue}</td>
        <td>${fileHTML}</td>
        <td>${formatTime(ticket.date)}</td>
        <td><button class="btn btn-success" onclick="resolveTicket(event, '${ticket.id}')">âœ“ Resolve</button></td>
      </tr>`;
    });

    tableHTML += `</tbody></table>`;
    container.innerHTML = tableHTML;
  }

  function resolveTicket(e, id) {
    if (!id) return;
    const button = e.currentTarget;
    if (!button || button.disabled) return;

    const row = button.closest('tr');
    button.disabled = true;
    button.innerHTML = '<span class="btn-spinner"></span> Resolving...';

    fetch(webAppURL, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify({action: "resolve", id: id}),
      headers: { "Content-Type": "application/json" }
    })
    .then(() => {
      showToast("Ticket resolved successfully!");
      if (row) {
        row.style.transition = 'all 0.4s ease';
        row.style.opacity = '0';
        row.style.transform = 'translateX(100px)';
        setTimeout(() => {
          row.remove();
          const tbody = document.querySelector('#ticketList tbody');
          if (tbody && tbody.children.length === 0) {
            document.getElementById("ticketList").innerHTML = `<div>No active tickets</div>`;
          }
        }, 400);
      }
      setTimeout(loadTickets, 1500);
    })
    .catch(() => {
      button.disabled = false;
      button.innerHTML = 'âœ“ Resolve';
    });
  }

  loadTickets();
  setInterval(loadTickets, 30000);
</script>
</body>
</html>
