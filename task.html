// अपना डिप्लॉय किया हुआ वेब ऐप URL यहाँ पेस्ट करें
const SCRIPT_URL = "YOUR_WEB_APP_URL"; 

const authContainer = document.getElementById('auth-container');
const appContainer = document.getElementById('app-container');
const loginForm = document.getElementById('login-form');
const signupForm = document.getElementById('signup-form');
const taskList = document.getElementById('task-list');
const taskInput = document.getElementById('task-input');
const messageArea = document.getElementById('message-area');
const loader = document.getElementById('loader');

// जब पेज लोड हो, तो चेक करें कि यूजर पहले से लॉगिन है या नहीं
document.addEventListener('DOMContentLoaded', () => {
    const loggedInUser = localStorage.getItem('loggedInUser');
    if (loggedInUser) {
        showAppView(loggedInUser);
    } else {
        showAuthView();
    }
});

function toggleForms() {
    loginForm.style.display = loginForm.style.display === 'none' ? 'block' : 'none';
    signupForm.style.display = signupForm.style.display === 'none' ? 'block' : 'none';
    messageArea.textContent = '';
}

function showLoader(show) {
    loader.style.display = show ? 'block' : 'none';
}

function showMessage(message, isError = false) {
    messageArea.textContent = message;
    messageArea.style.color = isError ? 'red' : 'green';
}

// नया यूजर बनाने के लिए
async function signupUser() {
    const username = document.getElementById('signup-username').value.trim();
    const password = document.getElementById('signup-password').value.trim();
    if (!username || !password) {
        showMessage('यूजरनेम और पासवर्ड दोनों भरें।', true);
        return;
    }
    
    showLoader(true);
    const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'signup', username, password }),
        headers: { 'Content-Type': 'application/json' },
        mode: 'no-cors', // Important for Apps Script POST
    });
    // no-cors mode doesn't allow reading response, so we just assume it worked and give feedback
    showLoader(false);
    showMessage('साइनअप सफल! अब आप लॉगिन कर सकते हैं।');
    toggleForms();
}

// यूजर को लॉगिन करने के लिए
async function loginUser() {
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value.trim();
    if (!username || !password) {
        showMessage('यूजरनेम और पासवर्ड दोनों भरें।', true);
        return;
    }

    showLoader(true);
    // For login, we can use a redirect trick to read the response or just trust it.
    // Here we'll do a proper POST and handle CORS in Apps Script. For simplicity let's do a different fetch:
    try {
        const res = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'login', username, password }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Use text/plain for some Apps Script scenarios
            redirect: 'follow',
        });
        const result = await res.json();
        showLoader(false);
        if (result.status === 'success') {
            localStorage.setItem('loggedInUser', username);
            showAppView(username);
        } else {
            showMessage(result.message, true);
        }
    } catch(e) {
        showLoader(false);
        showMessage("लॉगिन में कोई समस्या हुई।", true)
    }
}

// लॉगआउट
function logout() {
    localStorage.removeItem('loggedInUser');
    showAuthView();
}

function showAuthView() {
    authContainer.style.display = 'block';
    appContainer.style.display = 'none';
}

function showAppView(username) {
    authContainer.style.display = 'none';
    appContainer.style.display = 'block';
    document.getElementById('welcome-message').textContent = `स्वागत है, ${username}!`;
    loadTasks();
}

// यूजर के सभी टास्क लोड करें
async function loadTasks() {
    const username = localStorage.getItem('loggedInUser');
    if (!username) return;

    showLoader(true);
    taskList.innerHTML = ''; // पुरानी लिस्ट साफ़ करें
    try {
        const response = await fetch(`${SCRIPT_URL}?username=${username}`);
        const tasks = await response.json();
        showLoader(false);

        if(tasks.status === 'error'){
            showMessage(tasks.message, true);
            return;
        }

        tasks.forEach(task => {
            const li = document.createElement('li');
            li.textContent = task.taskText;
            li.dataset.taskId = task.taskID;
            if (task.status === 'completed') {
                li.classList.add('completed');
            }

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'task-actions';

            const toggleBtn = document.createElement('button');
            toggleBtn.textContent = task.status === 'completed' ? 'Undo' : 'Complete';
            toggleBtn.onclick = () => updateTaskStatus(task.taskID, task.status === 'completed' ? 'pending' : 'completed');
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = 'delete-btn';
            deleteBtn.onclick = () => deleteTask(task.taskID);

            actionsDiv.appendChild(toggleBtn);
            actionsDiv.appendChild(deleteBtn);
            li.appendChild(actionsDiv);
            taskList.appendChild(li);
        });
    } catch (error) {
        showLoader(false);
        showMessage('टास्क लोड करने में विफल।', true);
    }
}

// नया टास्क जोड़ें
async function addTask() {
    const taskText = taskInput.value.trim();
    if (taskText === '') return;

    const username = localStorage.getItem('loggedInUser');
    showLoader(true);
    await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'addTask', username, taskText }),
        mode: 'no-cors'
    });
    // Assuming success due to no-cors
    taskInput.value = '';
    setTimeout(loadTasks, 1000); // Wait a second for sheet to update
}

// टास्क का स्टेटस अपडेट करें
async function updateTaskStatus(taskID, newStatus) {
    showLoader(true);
    await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'updateTaskStatus', taskID, status: newStatus }),
        mode: 'no-cors'
    });
    setTimeout(loadTasks, 1000);
}

// टास्क डिलीट करें
async function deleteTask(taskID) {
    showLoader(true);
    await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'deleteTask', taskID }),
        mode: 'no-cors'
    });
    setTimeout(loadTasks, 1000);
}
